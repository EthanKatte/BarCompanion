{% extends "base.html" %}

{% block content %}
<div class="container mx-auto py-8">
  <h1 class="text-3xl font-bold mb-6">Admin Dashboard</h1>
      
  <!-- Top-right buttons -->
  <div class="absolute top-6 right-6 flex flex-wrap gap-4 mt-[40px]">
    <!-- Admin Button -->
    <a href="./fuckoff" class="btn btn-primary flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 object-contain" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h11M9 21V3m0 18h12" />
      </svg>
      Admin
    </a>

    <!-- Expert Notes Button -->
    <a href="./expert_notes" class="btn btn-secondary flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 object-contain" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-9-8h12a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2z" />
      </svg>
      Expert Notes
    </a>

    <!-- Update Expert Notes Button -->
    <button type="button" class="btn btn-secondary flex items-center" onclick="refreshData('notes')">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 object-contain" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-9-8h12a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2z" />
      </svg>
      Update Expert Notes
    </button>

    <!-- Update Descriptions Button -->
    <button type="button" class="btn btn-secondary flex items-center" onclick="refreshData('descriptions')">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 object-contain" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-9-8h12a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2z" />
      </svg>
      Update Descriptions
    </button>
  </div>

  <!-- Manual Removal Form -->
  <h2 class="text-2xl font-bold mb-6">Remove Entry</h2>
  <div class="form-control mb-6">
    <label class="label">
      <span class="label-text">Table Name</span>
    </label>
    <input id="table-name" type="text" placeholder="Enter table name (e.g., bottles)" class="input input-bordered" />
  </div>
  <div class="form-control mb-6">
    <label class="label">
      <span class="label-text">Record ID</span>
    </label>
    <input id="record-id" type="number" placeholder="Enter record ID" class="input input-bordered" />
  </div>
  <button class="btn btn-error" onclick="removeEntry()">Remove Entry</button>

  <!-- Make Bottle Unavailable Form -->
  <h2 class="text-2xl font-bold mb-6">Make Bottle Unavailable</h2>
  <div class="form-control mb-6">
    <label class="label">
      <span class="label-text">Bottle ID</span>
    </label>
    <input id="unavailable-bottle-id" type="number" placeholder="Enter bottle ID" class="input input-bordered" />
  </div>
  <button class="btn btn-warning" onclick="makeUnavailable()">Make Unavailable</button>


  {% for table, rows in tables_data.items() %}
  <h2 class="text-2xl font-bold mb-4">{{ table|capitalize }} Table</h2>
  <div class="overflow-x-auto mb-8">
    <table class="table table-zebra w-full border border-gray-500 rounded-md p-300 ">
      <thead>
        <tr>
          {% if rows %}
          {% for col in rows[0].keys() %}
          <th>{{ col }}</th>
          {% endfor %}
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          {% for col, value in row.items() %}
          <td>{{ value }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}
</div>
<script>
    async function refreshData(kind) {
      const limitInput = prompt("Optional limit (blank for all):", "");
      if (limitInput === null) {
        return;
      }

      let limit = null;
      if (limitInput.trim() !== "") {
        limit = Number.parseInt(limitInput, 10);
        if (!Number.isFinite(limit) || limit <= 0) {
          showAlert("Limit must be a positive number.", "error");
          return;
        }
      }

      const url = new URL("/api/refresh", window.location.origin);
      url.searchParams.set("id", kind);
      if (limit) {
        url.searchParams.set("limit", String(limit));
      }

      try {
        showLoadingOverlay();
        const response = await fetch(url.toString(), { method: "POST" });
        const result = await response.json();
        if (response.ok) {
          const updatedCount = Array.isArray(result.updated) ? result.updated.length : 0;
          const skippedCount = Array.isArray(result.skipped) ? result.skipped.length : 0;
          const errorCount = Array.isArray(result.errors) ? result.errors.length : 0;
          const alertType = errorCount ? "error" : "success";
          showAlert(
            `Refresh ${kind}: updated ${updatedCount}, skipped ${skippedCount}, errors ${errorCount}.`,
            alertType,
            6000
          );
          if (!errorCount) {
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          }
        } else {
          showAlert(result.error || "Failed to refresh data.", "error");
        }
      } catch (error) {
        console.error("Error refreshing data:", error);
        showAlert("An error occurred while refreshing data.", "error");
      } finally {
        hideLoadingOverlay();
      }
    }

    async function removeEntry() {
      const table = document.getElementById("table-name").value.trim();
      const id = document.getElementById("record-id").value.trim();
  
      if (!table || !id) {
        showAlert("Table name and record ID are required.", "error");
        return;
      }
  
      try {
        const response = await fetch("/api/remove_entry", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ table, id }),
        });
  
        const result = await response.json();
        if (response.ok) {
          showAlert(result.message, "success");
          setTimeout(() => {
            window.location.reload(); // Refresh the page to reflect changes
          }, 1000);
        } else {
          showAlert(result.error || "Failed to remove the entry.", "error");
        }
      } catch (error) {
        console.error("Error removing entry:", error);
        showAlert("An error occurred while removing the entry.", "error");
      }
    }


  async function makeUnavailable() {
    const bottleId = document.getElementById("unavailable-bottle-id").value.trim();

    if (!bottleId) {
      showAlert("Bottle ID is required.", "error");
      return;
    }

    try {
      const response = await fetch("/api/make_unavailable", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ id: bottleId }),
      });

      const result = await response.json();
      if (response.ok) {
        showAlert(result.message, "success");
        setTimeout(() => {
          window.location.reload(); // Refresh the page to reflect changes
        }, 1000);
      } else {
        showAlert(result.error || "Failed to make the bottle unavailable.", "error");
      }
    } catch (error) {
      console.error("Error making bottle unavailable:", error);
      showAlert("An error occurred while updating the bottle.", "error");
    }
  }

  </script>
{% endblock %}
