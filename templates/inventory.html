{% extends "base.html" %}

{% block title %}Inventory - Bar Companion{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Inventory</h1>
<div class="flex items-center justify-between mb-6">
  <div class="flex items-center space-x-4">
    <div class="border p-1">
      <label for="add-bottle-modal" class="btn btn-primary mr-2">Add Bottle +</label>
    </div>
    {% include "modals/add_bottle_button.html" %}
    <div class="border border-gray-500 rounded-md p-1">
      <label for="filter-bottles-modal" class="btn btn-primary">Filter ☰</label>
      {% include "modals/filter_bottle.html" %}
      <label onclick="window.location.href = '/inventory'" class="btn btn-tertiary">Clear Filters ×</label>
    </div>
    <label class="flex items-center space-x-2">
      <input 
        type="checkbox" 
        id="hide-unavailable-checkbox" 
        class="checkbox checkbox-primary"
        onchange="toggleAvailableBottles()"
      />
      <span>Hide Unavailable</span>
    </label>
  </div>
  
  <!-- Right-aligned Surprise Me Button -->          
  <div class="ml-auto">
    <button class="btn btn-secondary" onclick="openRandomBottleModal()">Surprise Me!</button>
  </div>
</div>

<div id="bottle-grid" class="grid grid-cols-3 gap-6">

  {% for bottle in bottles %}

  <div class="card w-full bg-base-100 shadow-lg" data-available="{{ bottle.available }}">
    <!-- Trigger Button -->
    <label for="modal-{{ bottle.id }}" class="cursor-pointer">
      <figure>
        <img
          data-src="/database_images/bottles/{{ bottle.image_path }}"
          alt="{{ bottle.name }}"
          class="lazy w-[250px] h-[250px] object-contain mx-auto bg-gray-100"
        />
      </figure>
      <div class="card-body">
        <h2 class="card-title">{{ bottle.brand }}</h2>
        <p>{{ bottle.name }}</p>
        <p>ABV: {{ bottle.abv }}</p>
      </div>
    </label>
  
    <!-- Modal -->
    {% include "modals/bottle_card_popup.html" %}
  </div>

  {% endfor %}

</div>
<div id="load-trigger" class="h-10"></div>
<script>
  async function openRandomBottleModal() {
    try {
      const response = await fetch("/api/random_bottle_id");
      const result = await response.json();

      if (response.ok) {
        // Open the modal for the random bottle
        const modalId = `modal-${result.id}`;
        const modalCheckbox = document.getElementById(modalId);

        if (modalCheckbox) {
          modalCheckbox.checked = true; // Open the modal
        } else {
          showAlert("Modal not found for the selected bottle.", "error");
        }
      } else {
        showAlert(result.error || "Failed to fetch a random bottle.", "error");
      }
    } catch (error) {
      console.error("Error fetching random bottle ID:", error);
      showAlert("An error occurred while fetching a random bottle.", "error");
    }
  }

  function toggleAvailableBottles() {
    const bottles = document.querySelectorAll("#bottle-grid .card");
    console.log("toggling");
    bottles.forEach((bottle) => {
      const isAvailable = bottle.getAttribute("data-available") === "1";
      if (!isAvailable) {
        bottle.classList.toggle("hidden");

      }
    });
  }


  let offset = 30;
  const limit = 30;
  let loading = false;

  const trigger = document.getElementById('load-trigger');
  const grid = document.getElementById('bottle-grid');

  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting && !loading) {
        loading = true;
        fetch(`/api/bottles?offset=${offset}&limit=${limit}`)
          .then(res => res.json())
          .then(bottles => {
            bottles.forEach(bottle => {
              const card = document.createElement('div');
              card.className = 'card w-full bg-base-100 shadow-lg';
              card.dataset.available = bottle.available;

              card.innerHTML = `
                <label for="modal-${bottle.id}" class="cursor-pointer">
                  <figure>
                    <img
                      data-src="/database_images/bottles/${bottle.image_path}"
                      alt="${bottle.name}"
                      class="lazy w-[250px] h-[250px] object-contain mx-auto bg-gray-100"
                    />
                  </figure>
                  <div class="card-body">
                    <h2 class="card-title">${bottle.brand}</h2>
                    <p>${bottle.name}</p>
                    <p>ABV: ${bottle.abv}</p>
                  </div>
                </label>
              `;

              grid.appendChild(card);
            });

            // Re-run lazy loading on new images
            const lazyImages = document.querySelectorAll('img.lazy');
            lazyImages.forEach(img => observerLazy.observe(img));

            offset += bottles.length;
            loading = false;

            if (bottles.length < limit) {
              observer.unobserve(trigger); // All bottles loaded
            }
          });
      }
    });
  }, { rootMargin: "300px" });

  observer.observe(trigger);

  // Lazy loading observer
  const observerLazy = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        observerLazy.unobserve(img);
      }
    });
  });

  document.querySelectorAll('img.lazy').forEach(img => observerLazy.observe(img));
</script>

{% endblock %}
