{% extends "base.html" %}

{% block title %}Inventory - John's bahr{% endblock %}

{% block content %}
{% set total_bottles = bottles|length %}
{% set available_bottles = bottles | selectattr("available", "equalto", 1) | list | length %}
{% set unavailable_bottles = total_bottles - available_bottles %}

<div class="catalog-shell">
  <div class="catalog-orb catalog-orb--a"></div>
  <div class="catalog-orb catalog-orb--b"></div>
  <div class="catalog-content">
    <div class="catalog-hero">
      <div>
        <p class="catalog-eyebrow">Cellar overview</p>
        <h1 class="catalog-title">Inventory</h1>
        <p class="catalog-subtitle">
          Browse every bottle in the collection, filter by style, and jump straight into a tasting note.
        </p>
        <div class="catalog-stats">
          <div class="catalog-stat">
            <span class="catalog-stat__label">Total bottles</span>
            <span class="catalog-stat__value">{{ total_bottles }}</span>
          </div>
          <div class="catalog-stat">
            <span class="catalog-stat__label">Available</span>
            <span class="catalog-stat__value">{{ available_bottles }}</span>
          </div>
          <div class="catalog-stat">
            <span class="catalog-stat__label">Unavailable</span>
            <span class="catalog-stat__value">{{ unavailable_bottles }}</span>
          </div>
        </div>
      </div>
      <div class="catalog-actions">
        <label for="add-bottle-modal" class="btn btn-primary catalog-btn">Add Bottle</label>
        <button class="btn btn-secondary catalog-btn" onclick="openRandomBottleModal()">Surprise Me</button>
      </div>
    </div>

    {% include "modals/add_bottle_button.html" %}

    <div class="catalog-controls">
      <div class="catalog-search">
        <label class="catalog-search__label" for="inventory-search">Search bottles</label>
        <input
          id="inventory-search"
          type="text"
          class="input input-bordered catalog-search__input"
          placeholder="Search brand, bottle, or style"
        />
        <div class="catalog-search__meta">
          <span id="inventory-count">{{ total_bottles }} bottles</span>
        </div>
      </div>
      <div class="catalog-controls__actions">
        <label class="catalog-toggle">
          <input
            type="checkbox"
            id="inventory-hide-unavailable"
            class="checkbox checkbox-primary"
          />
          <span>Hide unavailable</span>
        </label>
        <div class="catalog-filter-group">
          <label for="filter-bottles-modal" class="btn btn-primary">Filter</label>
          {% include "modals/filter_bottle.html" %}
          <button class="btn btn-tertiary" type="button" onclick="window.location.href = '/inventory'">
            Clear filters
          </button>
        </div>
      </div>
    </div>

    <div id="bottle-grid" class="catalog-grid">
      {% for bottle in bottles %}
      <div
        class="catalog-card{% if bottle.available != 1 %} is-unavailable{% endif %}"
        data-available="{{ bottle.available }}"
        data-search="{{ bottle.brand }} {{ bottle.name }} {{ bottle.spirit_type }} {{ bottle.subtype }}"
      >
        <div class="catalog-card__click bottle-card" data-bottle-id="{{ bottle.id }}">
          <div class="catalog-card__media">
            <img
              data-src="/database_images/bottles/{{ bottle.image_path }}"
              alt="{{ bottle.name }}"
              class="delayed"
            />
            {% if bottle.available == 1 %}
              <span class="catalog-badge catalog-badge--available">Available</span>
            {% else %}
              <span class="catalog-badge catalog-badge--unavailable">Unavailable</span>
            {% endif %}
          </div>
          <div class="catalog-card__body">
            <div class="catalog-card__header">
              <h2 class="catalog-card__brand">{{ bottle.brand }}</h2>
              <span class="catalog-card__abv">{{ bottle.abv }}</span>
            </div>
            <p class="catalog-card__name">{{ bottle.name }}</p>
            <div class="catalog-card__meta">
              <span class="catalog-chip">{{ bottle.spirit_type }}</span>
              {% if bottle.subtype %}
              <span class="catalog-chip catalog-chip--muted">{{ bottle.subtype }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<input type="checkbox" id="bottle-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box relative" id="bottle-modal-content">
    <p class="text-center">Loading...</p>
  </div>
  <label for="bottle-modal" class="modal-backdrop"></label>
</div>

<script>
  async function openRandomBottleModal() {
    try {
      const response = await fetch("/api/random_bottle_id");
      const result = await response.json();

      if (response.ok) {
        fetchAndOpenModal(result.id);
      } else {
        showAlert(result.error || "Failed to fetch a random bottle.", "error");
      }
    } catch (error) {
      console.error("Error fetching random bottle ID:", error);
      showAlert("An error occurred while fetching a random bottle.", "error");
    }
  }

  function applyInventoryFilters() {
    const searchInput = document.getElementById("inventory-search");
    const query = searchInput ? searchInput.value.trim().toLowerCase() : "";
    const hideUnavailable = document.getElementById("inventory-hide-unavailable")?.checked;
    const bottles = document.querySelectorAll("#bottle-grid .catalog-card");
    let visibleCount = 0;

    bottles.forEach((bottle) => {
      const searchText = (bottle.dataset.search || "").toLowerCase();
      const isAvailable = bottle.dataset.available === "1";
      const matchesSearch = !query || searchText.includes(query);
      const matchesAvailability = !hideUnavailable || isAvailable;
      const shouldShow = matchesSearch && matchesAvailability;

      bottle.classList.toggle("hidden", !shouldShow);
      if (shouldShow) {
        visibleCount += 1;
      }
    });

    const countEl = document.getElementById("inventory-count");
    if (countEl) {
      countEl.textContent = `${visibleCount} bottles`;
    }
  }

  function toggleAvailableBottles() {
    applyInventoryFilters();
  }

  //takes a bottle id and opens the modal for that bottle
  async function fetchAndOpenModal(bottleId) {
    const modalContent = document.getElementById("bottle-modal-content");
    const modalCheckbox = document.getElementById("bottle-modal");

    // Show modal and loading state
    modalCheckbox.checked = true;
    modalContent.innerHTML = `<div class="text-center py-6">Loading...</div>`;

    try {
      const response = await fetch("/modal/bottle", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bottle_id: bottleId }),
      });

      const html = await response.text();
      modalContent.innerHTML = html;

      const reviewForm = modalContent.querySelector(`#addReviewForm-${bottleId}`);
      if (reviewForm) {
        attachReviewSubmitListener(reviewForm, bottleId);
      }
    } catch (err) {
      console.error("Error loading modal content:", err);
      modalContent.innerHTML = `<div class="text-center text-error py-6">Failed to load bottle information.</div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const bottleCards = document.querySelectorAll(".bottle-card");
    bottleCards.forEach((card) => {
      card.addEventListener("click", () => {
        const bottleId = card.dataset.bottleId;
        fetchAndOpenModal(bottleId);
      });
    });

    const searchInput = document.getElementById("inventory-search");
    if (searchInput) {
      searchInput.addEventListener("input", applyInventoryFilters);
    }

    const hideUnavailable = document.getElementById("inventory-hide-unavailable");
    if (hideUnavailable) {
      hideUnavailable.addEventListener("change", applyInventoryFilters);
    }

    applyInventoryFilters();
  });

  //staggered loading
  document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
      const images = Array.from(document.querySelectorAll("img.delayed"));

      let i = 0;
      const interval = setInterval(() => {
        if (i >= images.length) {
          clearInterval(interval);
          return;
        }

        const img = images[i];
        if (img.dataset.src) {
          img.src = img.dataset.src;
          img.classList.remove("delayed");
        }

        i++;
      }, 50);
    }, 100);
  });

  //review submit listener
  function attachReviewSubmitListener(form, bottleId) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const jsonData = { bottle_id: bottleId, notes: [] };

      formData.forEach((value, key) => {
        if (key.startsWith("note_") || key.startsWith("subnote_") || key.startsWith("subsubnote_")) {
          jsonData.notes.push(key);
        } else {
          jsonData[key] = value;
        }
      });

      try {
        showLoadingOverlay();
        const response = await fetch("/api/add_review", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(jsonData),
        });

        const result = await response.json();
        if (response.ok) {
          showAlert("Review added successfully!", "success");
          e.target.reset();
          document.getElementById("bottle-modal").checked = false;
        } else {
          showAlert(result.error || "Failed to add the review.", "error");
        }
      } catch (err) {
        console.error(err);
        showAlert("An error occurred while adding the review.", "error");
      } finally {
        hideLoadingOverlay();
      }
    });
  }
</script>

{% endblock %}
