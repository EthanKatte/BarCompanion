{% extends "base.html" %}

{% block title %}Inventory - John's bahr{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Inventory</h1>
<div class="flex items-center justify-between mb-6">
  <div class="flex items-center space-x-4">
    <div class="border p-1">
      <label for="add-bottle-modal" class="btn btn-primary mr-2">Add Bottle +</label>
    </div>
    {% include "modals/add_bottle_button.html" %}
    <div class="border border-gray-500 rounded-md p-1">
      <label for="filter-bottles-modal" class="btn btn-primary">Filter ☰</label>
      {% include "modals/filter_bottle.html" %}
      <label onclick="window.location.href = '/inventory'" class="btn btn-tertiary">Clear Filters ×</label>
    </div>
    <label class="flex items-center space-x-2">
      <input 
        type="checkbox" 
        id="hide-unavailable-checkbox" 
        class="checkbox checkbox-primary"
        onchange="toggleAvailableBottles()"
      />
      <span>Hide Unavailable</span>
    </label>
  </div>
  
  <!-- Right-aligned Surprise Me Button -->          
  <div class="ml-auto">
    <button class="btn btn-secondary" onclick="openRandomBottleModal()">Surprise Me!</button>
  </div>
</div>

<div id="bottle-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-9 gap-6">
  {% for bottle in bottles %}
  <div class="card w-full bg-base-100 shadow-lg" data-available="{{ bottle.available }}">
    <div
      class="cursor-pointer bottle-card"
      data-bottle-id="{{ bottle.id }}"
    >
      <figure>
        <img
          data-src="/database_images/bottles/{{ bottle.image_path }}"
          alt="{{ bottle.name }}"
          class="delayed w-[250px] h-[250px] object-contain mx-auto bg-gray-100"
        />
      </figure>
      <div class="card-body">
        <h2 class="card-title">{{ bottle.brand }}</h2>
        <p>{{ bottle.name }}</p>
        <p>ABV: {{ bottle.abv }}</p>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
<input type="checkbox" id="bottle-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box relative" id="bottle-modal-content">
    <p class="text-center">Loading...</p>
  </div>
  <label for="bottle-modal" class="modal-backdrop"></label>
</div>
<script>
  async function openRandomBottleModal() {
    try {
      const response = await fetch("/api/random_bottle_id");
      const result = await response.json();

      if (response.ok) {
        fetchAndOpenModal(result.id);
      } else {
        showAlert(result.error || "Failed to fetch a random bottle.", "error");
      }
    } catch (error) {
      console.error("Error fetching random bottle ID:", error);
      showAlert("An error occurred while fetching a random bottle.", "error");
    }
  }

  function toggleAvailableBottles() {
    const bottles = document.querySelectorAll("#bottle-grid .card");
    console.log("toggling");
    bottles.forEach((bottle) => {
      const isAvailable = bottle.getAttribute("data-available") === "1";
      if (!isAvailable) {
        bottle.classList.toggle("hidden");

      }
    });
  }

  //takes a bottle id and opens the modal for that bottle
  async function fetchAndOpenModal(bottleId) {
    const modalContent = document.getElementById("bottle-modal-content");
    const modalCheckbox = document.getElementById("bottle-modal");

    // Show modal and loading state
    modalCheckbox.checked = true;
    modalContent.innerHTML = `<div class="text-center py-6">Loading...</div>`;

    try {
      const response = await fetch("/modal/bottle", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bottle_id: bottleId }),
      });

      const html = await response.text();
      modalContent.innerHTML = html;

      const reviewForm = modalContent.querySelector(`#addReviewForm-${bottleId}`);
      if (reviewForm) {
        attachReviewSubmitListener(reviewForm, bottleId);
      }
    } catch (err) {
      console.error("Error loading modal content:", err);
      modalContent.innerHTML = `<div class="text-center text-error py-6">Failed to load bottle information.</div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const bottleCards = document.querySelectorAll(".bottle-card");

    bottleCards.forEach(card => {
      card.addEventListener("click", () => {
        const bottleId = card.dataset.bottleId;
        fetchAndOpenModal(bottleId);
      });
    });
  });


  //staggered loading
   document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    const images = Array.from(document.querySelectorAll('img.delayed'));
    
    let i = 0;
    const interval = setInterval(() => {
      console.log("loading image")
      if (i >= images.length) {
        clearInterval(interval);
        return;
      }

      const img = images[i];
      if (img.dataset.src) {
        img.src = img.dataset.src;
        img.classList.remove('delayed');
      }

      i++;
    }, 50); // Load one image every 30ms (adjust for performance)
  }, 100); // Start loading after 500ms
});

//review submit listener
function attachReviewSubmitListener(form, bottleId) {
  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const jsonData = { bottle_id: bottleId, notes: [] };

    formData.forEach((value, key) => {
      if (key.startsWith("note_") || key.startsWith("subnote_") || key.startsWith("subsubnote_")) {
        jsonData.notes.push(key);
      } else {
        jsonData[key] = value;
      }
    });

    try {
      showLoadingOverlay();
      const response = await fetch("/api/add_review", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(jsonData),
      });

      const result = await response.json();
      if (response.ok) {
        showAlert("Review added successfully!", "success");
        e.target.reset();
        document.getElementById("bottle-modal").checked = false;
      } else {
        showAlert(result.error || "Failed to add the review.", "error");
      }
    } catch (err) {
      console.error(err);
      showAlert("An error occurred while adding the review.", "error");
    } finally {
      hideLoadingOverlay();
    }
  });
}


</script>

{% endblock %}
