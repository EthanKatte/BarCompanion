<input type="checkbox" id="add-user-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Add a New User</h3>
    <form id="addUserForm" class="space-y-4">
      <!-- Name -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Name</span>
        </label>
        <input type="text" name="name" class="input input-bordered" required />
      </div>

      <!-- Image -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Take a Photo</span>
        </label>
        <div id="camera-container" class="mb-4">
          <video id="video" autoplay class="max-w-xs"></video>
          <canvas id="canvas" class="hidden"></canvas>
        </div>
        <button type="button" class="btn btn-primary" id="capture-button">Capture Photo</button>
        <input type="hidden" name="photo" id="photo-data" />
      </div>

      <!-- Submit Button -->
      <div class="modal-action">
        <button type="submit" class="btn btn-primary">Add User</button>
        <label for="add-user-modal" class="btn">Cancel</label>
      </div>
    </form>
  </div>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const captureButton = document.getElementById("capture-button");
const photoData = document.getElementById("photo-data");

// Access the user's camera
navigator.mediaDevices
  .getUserMedia({ video: true })
  .then((stream) => {
    video.srcObject = stream;
  })
  .catch((err) => {
    console.error("Camera access denied:", err);
    showAlert("Unable to access the camera. Please check your device permissions.", "error");
  });

// Capture the photo
captureButton.addEventListener("click", () => {
  const context = canvas.getContext("2d");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);

  // Convert the image to a data URL and store it in the hidden input
  const imageData = canvas.toDataURL("image/png");
  photoData.value = imageData;

  showAlert("Photo captured! Submit the form to upload it.", "success");
});

// Handle form submission
document.getElementById("addUserForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  // Get form data
  const formData = new FormData(e.target);
  const jsonData = {};
  formData.forEach((value, key) => (jsonData[key] = value));

  // Send POST request
  try {
    const response = await fetch("http://192.168.0.145:5000/api/add_user", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(jsonData),
    });

    const result = await response.json();
    if (response.ok) {
      showAlert("User added successfully!", "success");
      e.target.reset(); // Reset the form
      document.getElementById("add-user-modal").checked = false; // Close the modal
    } else {
      showAlert(result.error || "Failed to add the user.", "error");
    }
  } catch (error) {
    showAlert("An error occurred while adding the user.", "error");
    console.error(error);
  }
});
</script>
