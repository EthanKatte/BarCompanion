<input type="checkbox" id="add-bottle-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Add a New Bottle</h3>
    <form id="addBottleForm" class="space-y-4">
      <!-- Brand -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Brand</span>
        </label>
        <input type="text" name="brand" class="input input-bordered" required />
      </div>

      <!-- Name -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Name</span>
        </label>
        <input type="text" name="name" class="input input-bordered" required />
      </div>

      <!-- ABV -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">ABV</span>
        </label>
        <input type="number" name="abv" class="input input-bordered" placeholder="e.g., 40%" required />
      </div>

      <!-- Type -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Type</span>
        </label>
        <input type="text" name="spirit_type" class="input input-bordered" required />
      </div>

      <!-- Subtype -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Subtype</span>
        </label>
        <input type="text" name="subtype" class="input input-bordered" />
      </div>

      <!-- Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Description</span>
        </label>
        <textarea name="description" class="textarea textarea-bordered"></textarea>
      </div>

      <!-- File Upload -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Upload Image</span>
        </label>
        <input type="file" name="photo" id="image-upload" class="file-input file-input-bordered" accept="image/*" required />
      </div>

      <!-- Submit Button -->
      <div class="modal-action">
        <button type="submit" class="btn btn-primary">Add Bottle</button>
        <label for="add-bottle-modal" class="btn">Cancel</label>
      </div>
    </form>

    <!-- Close Button -->
    <label for="add-bottle-modal" class="btn btn-sm btn-circle absolute right-2 top-2">âœ•</label>
  </div>
  <!-- Overlay (click outside to close) -->
  <label for="add-bottle-modal" class="modal-backdrop"></label>

</div>

<script>
  document.getElementById("addBottleForm").addEventListener("submit", async function (e) {
    e.preventDefault(); // Prevent default form submission

    // Get form data
    const formData = new FormData(e.target);
    const jsonData = {};

    formData.forEach((value, key) => {
      jsonData[key] = value;
    });

    const fileInput = document.getElementById("image-upload");
    const file = fileInput.files[0];

    if (!file) {
      showAlert("Please upload an image.", "error");
      return;
    }

    // Convert the image file to Base64
    const base64Image = await fileToBase64(file);
    jsonData.photo = base64Image;

    try {
      // Send POST request to check if bottle exists
      showLoadingOverlay();
      const existsResponse = await fetch(
        `/api/check_bottle?brand=${encodeURIComponent(jsonData.brand)}&name=${encodeURIComponent(jsonData.name)}`
      );
      const existsResult = await existsResponse.json();

      if (existsResult.exists) {
        showAlert("This bottle already exists in the database.", "error");
        return;
      }

      // Send POST request to add the bottle
      const response = await fetch("http://192.168.0.145:5000/api/add_bottle", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(jsonData),
      });

      if (response.ok) {
        showAlert("Bottle added successfully!", "success");
        setTimeout(() => {
          location.reload(); // Refresh the page after success
        }, 1000);
      } else {
        const error = await response.json();
        showAlert(error.error || "Failed to add the bottle.", "error");
      }
    } catch (error) {
      console.error("Error submitting form:", error);
      showAlert("An error occurred while adding the bottle.", "error");
    }
    hideLoadingOverlay();
  });

  // Helper function to convert file to Base64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
      reader.readAsDataURL(file);
    });
  }
</script>
