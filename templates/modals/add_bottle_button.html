<input type="checkbox" id="add-bottle-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Add a New Bottle</h3>
    <form id="addBottleForm" class="space-y-4">
      <!-- Brand -->
      <div class="form-control">
        {% set brand_ns = namespace(brands=[]) %}
        {% for bottle in bottles %}
          {% if bottle.brand is not none %}
            {% set clean_brand = bottle.brand.strip() %}
            {% if clean_brand != '' and clean_brand not in brand_ns.brands %}
              {% set _ = brand_ns.brands.append(clean_brand) %}
            {% endif %}
          {% endif %}
        {% endfor %}

        <label class="label">
          <span class="label-text">Brand*</span>
        </label>

        <select name="brand_select" class="select select-bordered" id="brandSelect" required>
          {% for brand in brand_ns.brands %}
            <option value="{{ brand }}">{{ brand }}</option>
          {% endfor %}
          <option value="__custom__">[New Entry]</option>
        </select>

        <input type="text" name="brand" id="customBrand"
              class="input input-bordered mt-2 hidden"
              placeholder="Enter custom brand" />
      </div>

      <!-- Name -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Name*</span>
        </label>
        <input type="text" name="name" class="input input-bordered" required />
      </div>

      <!-- ABV -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">ABV*</span>
        </label>
        <input type="number" name="abv" class="input input-bordered" placeholder="e.g., 40" required />
      </div>

    <!-- Type -->
    <div class="form-control">
      {% set type_ns = namespace(spirit_types=[]) %}
      {% for bottle in bottles %}
        {% if bottle.spirit_type is not none %}
          {% if bottle.spirit_type and bottle.spirit_type.strip() %}
            {% if bottle.spirit_type not in type_ns.spirit_types %}
              {% set _ = type_ns.spirit_types.append(bottle.spirit_type) %}
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}

      <label class="label">
        <span class="label-text">Type*</span>
      </label>

      <select name="spirit_type_select" class="select select-bordered" id="spiritTypeSelect" required>
        {% for type in type_ns.spirit_types %}
          <option value="{{ type }}">{{ type }}</option>
        {% endfor %}
        <option value="__custom__">[New Entry]</option>
      </select>

      <input type="text" name="spirit_type" id="customSpiritType"
            class="input input-bordered mt-2 hidden"
            placeholder="Enter custom type" />
    </div>

      <!-- Subtype -->
      <div class="form-control">
      {% set subtype_ns = namespace(subtypes=[]) %}
      {% for bottle in bottles %}
        {% if bottle.subtype is not none %}
          {% set clean_subtype = bottle.subtype.strip() %}
          {% if clean_subtype != '' and clean_subtype not in subtype_ns.subtypes %}
            {% set _ = subtype_ns.subtypes.append(clean_subtype) %}
          {% endif %}
        {% endif %}
      {% endfor %}

        <label class="label">
          <span class="label-text">Subtype</span>
        </label>

        <select name="subtype_select" class="select select-bordered" id="subtypeSelect">
          {% for subtype in subtype_ns.subtypes %}
            <option value="{{ subtype }}">{{ subtype }}</option>
          {% endfor %}
          <option value="__custom__">[New Entry]</option>
        </select>

        <input type="text" name="subtype" id="customSubtype"
              class="input input-bordered mt-2 hidden"
              placeholder="Enter custom subtype" />
      </div>

      <!-- Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Description</span>
        </label>
        <textarea name="description" class="textarea textarea-bordered"></textarea>
      </div>

      <!-- File Upload -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Upload Image</span>
        </label>
        <input type="file" name="photo" id="image-upload" class="file-input file-input-bordered" accept="image/*" />
      </div>

      <div class="form-control">
        <button type="button" id="findImagesBtn" class="btn btn-secondary">
          Find Images
        </button>
      </div>

      <div id="image-options" class="grid grid-cols-3 gap-4 mt-4"></div>
      <input type="hidden" name="selected_image_url" id="selectedImageUrl">

      <!-- Submit Button -->
      <div class="modal-action">
        <button type="submit" class="btn btn-primary">Add Bottle</button>
        <label for="add-bottle-modal" class="btn">Cancel</label>
      </div>
    </form>

    <!-- Close Button -->
    <label for="add-bottle-modal" class="btn btn-sm btn-circle absolute right-2 top-2">âœ•</label>
  </div>
  <!-- Overlay (click outside to close) -->
  <label for="add-bottle-modal" class="modal-backdrop"></label>

</div>

<script>
  //spirit brand selection
  const brandSelect = document.getElementById('brandSelect');
  const customBrandInput = document.getElementById('customBrand');

  brandSelect.addEventListener('change', function () {
    if (this.value === '__custom__') {
      customBrandInput.classList.remove('hidden');
      customBrandInput.required = true;
    } else {
      customBrandInput.classList.add('hidden');
      customBrandInput.required = false;
      customBrandInput.value = '';
    }
  });

  //spirit sybtype selection
  const subtypeSelect = document.getElementById('subtypeSelect');
  const customSubtypeInput = document.getElementById('customSubtype');

  subtypeSelect.addEventListener('change', function () {
    if (this.value === '__custom__') {
      customSubtypeInput.classList.remove('hidden');
      customSubtypeInput.required = true;
    } else {
      customSubtypeInput.classList.add('hidden');
      customSubtypeInput.required = false;
      customSubtypeInput.value = '';
    }
  });

  //spirit type selection
  const select = document.getElementById('spiritTypeSelect');
  const customInput = document.getElementById('customSpiritType');

  select.addEventListener('change', function () {
    if (this.value === '__custom__') {
      customInput.classList.remove('hidden');
      customInput.required = true;
    } else {
      customInput.classList.add('hidden');
      customInput.required = false;
      customInput.value = '';
    }
  });

  //submit form
  document.getElementById("addBottleForm").addEventListener("submit", async function (e) {
    e.preventDefault(); // Prevent default form submission

    // Get form data
    const formData = new FormData(e.target);
    const jsonData = {};

    formData.forEach((value, key) => {
      jsonData[key] = value;
    });

    const fileInput = document.getElementById("image-upload");
    const file = fileInput.files[0];

    const selectedBase64 = document.getElementById("selectedImageUrl").value;

    if (selectedBase64 && selectedBase64.startsWith("data:")) {
      jsonData.photo = selectedBase64;
    } else if (file) {
      const base64Image = await fileToBase64(file);
      jsonData.photo = base64Image;
    } else {
      showAlert("Please either select an image or upload one.", "error");
      return;
    }

    showLoadingOverlay();
    try {
      // Send POST request to check if bottle exists
      const existsResponse = await fetch(
        `/api/check_bottle?brand=${encodeURIComponent(jsonData.brand)}&name=${encodeURIComponent(jsonData.name)}`
      );
      const existsResult = await existsResponse.json();

      if (existsResult.exists) {
        showAlert("This bottle already exists in the database.", "error");
        return;
      }

      // Send POST request to add the bottle
      const response = await fetch("/api/add_bottle", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(jsonData),
      });

      if (response.ok) {
        showAlert("Bottle added successfully!", "success");
        setTimeout(() => {
          location.reload(); // Refresh the page after success
        }, 1000);
      } else {
        const error = await response.json();
        showAlert(error.error || "Failed to add the bottle.", "error");
      }
    } catch (error) {
      console.error("Error submitting form:", error);
      showAlert("An error occurred while adding the bottle.", "error");
      hideLoadingOverlay();
    }
  });

  // Helper function to convert file to Base64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
      reader.readAsDataURL(file);
    });
  }

  async function urlToBase64(url) {
    const response = await fetch(url);
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }



 document.getElementById("findImagesBtn").addEventListener("click", async function () {
    const brandSelect = document.getElementById("brandSelect");
    const brandInput  = document.getElementById("customBrand");
    const nameInput   = document.querySelector("input[name='name']");

    const brand = brandSelect.value === "__custom__" ? brandInput.value : brandSelect.value;
    const name  = nameInput.value;

    if (!brand || !name) {
      showAlert("Please enter a brand and name first.", "error");
      return;
    }

    try {
      const res  = await fetch(`/get_images?brand=${encodeURIComponent(brand)}&name=${encodeURIComponent(name)}`);
      const data = await res.json();
      displayImageOptions(data.images);
    } catch (err) {
      console.error(err);
      showAlert("Failed to fetch images.", "error");
    }
  });

  function isDataUrl(str) {
    return typeof str === "string" && str.startsWith("data:image/");
  }

  // sets the div for showing the "find images" options
  async function displayImageOptions(images) {
    const container = document.getElementById("image-options");
    container.innerHTML = ""; // clear previous

    if (!images || !images.length) {
      container.innerHTML = "<p>No images found. Try different keywords or upload manually.</p>";
      return;
    }

    images.forEach((src) => {
      const div = document.createElement("div");
      div.className = "border p-1 cursor-pointer hover:shadow-lg rounded";

      const img = document.createElement("img");
      img.src = src;                    // works for data URLs AND http(s) URLs
      img.alt = "Suggested bottle image";
      img.loading = "lazy";
      img.className = "w-full h-auto";
      div.appendChild(img);

      div.addEventListener("click", async () => {
        document.querySelectorAll("#image-options div").forEach(d => d.classList.remove("ring", "ring-primary"));
        div.classList.add("ring", "ring-primary");

        let chosen;
        if (isDataUrl(src)) {
          // already base64 data URL from the server
          chosen = src;
        } else {
          // fallback if you ever pass plain URLs
          chosen = await urlToBase64(src);
        }

        document.getElementById("selectedImageUrl").value = chosen; // store in hidden input

        // Optional live preview if you have an <img id="selectedImagePreview">
        const preview = document.getElementById("selectedImagePreview");
        if (preview) preview.src = chosen;
      });

      container.appendChild(div);
    });
  }
</script>
